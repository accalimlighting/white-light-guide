import { execSync } from 'child_process';
import { writeFileSync, mkdirSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

function formatDate(dateStr) {
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return null;
  return d.toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric',
  });
}

function getLastCommitDate() {
  try {
    const raw = execSync('git log -1 --format=%cs', { stdio: ['ignore', 'pipe', 'ignore'] })
      .toString()
      .trim();
    const formatted = formatDate(raw);
    if (formatted) return formatted;
  } catch (_) {
    // ignore and fallback
  }
  return formatDate(new Date().toISOString());
}

const lastUpdated = getLastCommitDate() || 'Unknown';
const targetPath = join(__dirname, '..', 'src', 'lastUpdated.js');

mkdirSync(dirname(targetPath), { recursive: true });
writeFileSync(
  targetPath,
  `// Auto-generated by scripts/write-last-updated.js\nexport default '${lastUpdated}';\n`,
  'utf8'
);

console.log(`lastUpdated set to: ${lastUpdated}`);
