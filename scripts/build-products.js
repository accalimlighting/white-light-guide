import { writeFileSync } from 'fs';
import { fileURLToPath, pathToFileURL } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const hidePricing = process.env.VITE_HIDE_PRICING === 'true';

const sourceModulePath = pathToFileURL(join(__dirname, '..', 'src', 'data', 'products.js')).href;
const outputPath = join(__dirname, '..', 'src', 'data', 'products.generated.js');

function sanitizeProducts({ products, categories, ipRatings }) {
  if (!hidePricing) {
    return { products, categories, ipRatings };
  }

  const scrubPriceFields = (obj) => {
    if (!obj) return obj;
    const copy = { ...obj };
    delete copy.price;
    delete copy.pricePer;
    return copy;
  };

  const sanitizedProducts = products.map((product) => {
    const copy = { ...product };

    if (Array.isArray(copy.variants)) {
      copy.variants = copy.variants.map((variant) => scrubPriceFields(variant));
    }

    if (copy.accessories && typeof copy.accessories === 'object') {
      const newAccessories = {};
      Object.entries(copy.accessories).forEach(([key, items]) => {
        if (Array.isArray(items)) {
          newAccessories[key] = items.map((item) => scrubPriceFields(item));
        }
      });
      copy.accessories = newAccessories;
    }

    return copy;
  });

  return { products: sanitizedProducts, categories, ipRatings };
}

async function run() {
  const { products, categories, ipRatings } = await import(sourceModulePath);
  const { products: outProducts, categories: outCategories, ipRatings: outIp } = sanitizeProducts({
    products,
    categories,
    ipRatings,
  });

  const banner = '// Auto-generated by scripts/build-products.js\n';
  const body = `${banner}export const products = ${JSON.stringify(outProducts, null, 2)};\n` +
               `export const categories = ${JSON.stringify(outCategories, null, 2)};\n` +
               `export const ipRatings = ${JSON.stringify(outIp, null, 2)};\n`;

  writeFileSync(outputPath, body, 'utf8');
  console.log(`products.generated.js written${hidePricing ? ' (pricing stripped)' : ''}`);
}

run().catch((err) => {
  console.error(err);
  process.exit(1);
});
